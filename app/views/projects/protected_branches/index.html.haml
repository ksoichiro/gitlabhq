= render "projects/commits/head"
.row
  .col-md-3
    = render "projects/branches/filter"
  .col-md-9
    .bs-callout.bs-callout-info
      %p ブランチの保護は、 #{link_to "Master", help_permissions_path, class: "vlink"} 権限以外のメンバーによるプッシュからブランチを守るために設計されています。
      %p ブランチの保護により次のことを実現できます。
      %ul
        %li 安定したブランチを守る
        %li ブランチにマージする前のコードレビューを強制する
      %p プロジェクトの権限についての詳細は #{link_to "こちら", help_permissions_path, class: "underlined-link"} からご確認ください。

    - if can? current_user, :admin_project, @project
      = form_for [@project, @protected_branch], html: { class: 'form-horizontal' } do |f|
        -if @protected_branch.errors.any?
          .alert.alert-danger
            %ul
              - @protected_branch.errors.full_messages.each do |msg|
                %li= msg

        .form-group
          = f.label :name, "ブランチ", class: 'control-label'
          .col-sm-10
            = f.select(:name, @project.open_branches.map { |br| [br.name, br.name] } , {include_blank: "ブランチを選択"}, {class: "select2"})
        .form-actions
          = f.submit '保護', class: "btn-create btn"
    - unless @branches.empty?
      %h5 保護中のブランチ:
      %ul.bordered-list.protected-branches-list
        - @branches.each do |branch|
          %li
            %h4
              = link_to project_commits_path(@project, branch.name) do
                %strong= branch.name
                - if @project.root_ref?(branch.name)
                  %span.label.label-info デフォルト
                %span.label.label-success
                  %i.icon-lock
              .pull-right
                - if can? current_user, :admin_project, @project
                  = link_to '保護を解除', [@project, branch], data: { confirm: 'ブランチがDeveloper権限のメンバーにも書き込み可能になります。よろしいですか？' }, method: :delete, class: "btn btn-remove btn-small"

            - if commit = branch.commit
              = link_to project_commit_path(@project, commit.id), class: 'commit_short_id' do
                = commit.short_id
              %span.light
                = gfm escape_once(truncate(commit.title, length: 40))
              #{time_ago_with_tooltip(commit.committed_date)}
            - else
              (ブランチはリポジトリから削除されています)
