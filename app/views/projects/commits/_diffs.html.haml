- @suppress_diff ||= @suppress_diff || @force_suppress_diff
- if @suppress_diff
  .alert.alert-warning
    %p
      %strong 警告！これは大きな差分です。
    %p
      パフォーマンスを維持するため、差分行は表示されません。
      - if current_controller?(:commit) or current_controller?(:merge_requests)
        - if current_controller?(:commit)
          Please, download the diff as
          = link_to "plain diff", project_commit_path(@project, @commit, format: :diff), class: "underlined-link"
          or
          = link_to "email patch", project_commit_path(@project, @commit, format: :patch), class: "underlined-link"
          instead.
        - elsif @merge_request && @merge_request.persisted?
          Please, download the diff as
          = link_to "plain diff", project_merge_request_path(@project, @merge_request, format: :diff), class: "underlined-link"
          or
          = link_to "email patch", project_merge_request_path(@project, @merge_request, format: :patch), class: "underlined-link"
          instead.
    - unless @force_suppress_diff
      %p
        If you still want to see the diff
        = link_to "click this link", url_for(force_show_diff: true), class: "underlined-link"

%p.commit-stat-summary
  %strong.cdark #{diffs.count}つのファイル
  - if current_controller?(:commit)
    - unless @commit.has_zero_stats?
      の
      %strong.cgreen #{@commit.stats.additions}個の追加
      と
      %strong.cred #{@commit.stats.deletions}個の削除
  を表示しています
  - if params[:view] == 'parallel'
    = link_to "Inline Diff", url_for(view: 'inline'), {id: "commit-diff-viewtype", class: 'btn btn-tiny pull-right'}
  - else
    = link_to "Side-by-side Diff", url_for(view: 'parallel'), {id: "commit-diff-viewtype", class: 'btn btn-tiny pull-right'}
.file-stats
  = render "projects/commits/diff_head", diffs: diffs

.files
  - unless @suppress_diff
    - diffs.each_with_index do |diff, i|
      - file = project.repository.blob_at(@commit.id, diff.new_path)
      - file = project.repository.blob_at(@commit.parent_id, diff.old_path) unless file
      - next unless file
      .diff-file.js-toggle-container{id: "diff-#{i}"}
        .diff-header{id: "file-path-#{hexdigest(diff.new_path || diff.old_path)}"}
          - if diff.deleted_file
            %span= diff.old_path

            .diff-btn-group
              - if @commit.parent_ids.present?
                = link_to project_blob_path(project, tree_join(@commit.parent_id, diff.new_path)), { class: 'btn btn-small view-file' } do
                  ファイルを表示 @
                  %span.commit-short-id= @commit.short_id(6)
          - else
            %span= diff.new_path
            - if diff_file_mode_changed?(diff)
              %span.file-mode= "#{diff.a_mode} → #{diff.b_mode}"

            .diff-btn-group
              = link_to "#", class: "js-toggle-button btn btn-small" do
                %i.icon-chevron-down
                Diff comments
              &nbsp;

              - if @merge_request && @merge_request.source_project
                = link_to project_edit_tree_path(@merge_request.source_project, tree_join(@merge_request.source_branch, diff.new_path), from_merge_request_id: @merge_request.id), { class: 'btn btn-small' } do
                  編集
                &nbsp;

              = link_to project_blob_path(project, tree_join(@commit.id, diff.new_path)), { class: 'btn btn-small view-file' } do
                ファイルを表示 @
                %span.commit-short-id= @commit.short_id(6)


        .diff-content
          -# Skipp all non non-supported blobs
          - next unless file.respond_to?('text?')
          - if file.text?
            - if params[:view] == 'parallel'
              = render "projects/commits/parallel_view", diff: diff, project: project, file: file, index: i
            - else
              = render "projects/commits/text_file", diff: diff, index: i
          - elsif file.image?
            - old_file = project.repository.blob_at(@commit.parent_id, diff.old_path) if @commit.parent_id
            = render "projects/commits/image", diff: diff, old_file: old_file, file: file, index: i
          - else
            .nothing-here-block このファイルタイプではプレビューできません
