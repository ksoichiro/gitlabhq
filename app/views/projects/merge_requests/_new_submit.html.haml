%h3.page-title
  新しいマージリクエスト
%p.slead
  From
  %strong.label-branch #{@merge_request.source_project_namespace}:#{@merge_request.source_branch}
  %span を
  %strong.label-branch #{@merge_request.target_project_namespace}:#{@merge_request.target_branch}
  %span にマージ

  %span.pull-right
    = link_to 'ブランチを変更', new_project_merge_request_path(@project)

= form_for [@project, @merge_request], html: { class: "merge-request-form form-horizontal gfm-form" } do |f|
  .merge-request-form-info
    .form-group
      = f.label :title, class: 'control-label' do
        %strong タイトル *
      .col-sm-10
        = f.text_field :title, maxlength: 255, autofocus: true, class: 'form-control pad js-gfm-input', required: true
    .form-group.issuable-description
      = f.label :description, '説明', class: 'control-label'
      .col-sm-10
        = render layout: 'projects/md_preview', locals: { preview_class: "wiki" } do
          = render 'projects/zen', f: f, attr: :description, classes: 'description form-control'

          .col-sm-12-hint
            .pull-left
              #{link_to 'Gitlab Flavored Markdown', help_page_path('markdown', 'markdown'), target: '_blank'}.
              形式でパースされます
            .pull-right
              ドラッグ &amp; ドロップまたは#{link_to 'ファイルを選択', '#', class: 'markdown-selector'}.
              して画像 (JPG, PNG, GIF) を添付

          .clearfix
          .error-alert
    %hr
    .form-group
      .issue-assignee
        = f.label :assignee_id, class: 'control-label' do
          %i.fa.fa-user
          担当者
      .col-sm-10
        = project_users_select_tag('merge_request[assignee_id]', placeholder: 'ユーザを選択', class: 'custom-form-control', selected: @merge_request.assignee_id, project_id: @merge_request.target_project_id)
        &nbsp;
        = link_to '自分に割り当て', '#', class: 'btn assign-to-me-link'
    .form-group
      .issue-milestone
        = f.label :milestone_id, class: 'control-label' do
          %i.fa.fa-clock-o
          マイルストーン
        .col-sm-10
          - if milestone_options(@merge_request).present?
            = f.select(:milestone_id, milestone_options(@merge_request), {include_blank: 'マイルストーンを選択'}, {class: 'select2'})
          - else
            %span.light マイルストーンがありません
          &nbsp;
          - if can? current_user, :admin_milestone, @merge_request.target_project
            = link_to 'マイルストーンを作成', new_project_milestone_path(@merge_request.target_project), target: :blank
    .form-group
      = f.label :label_ids, class: 'control-label' do
        %i.fa.fa-tag
        ラベル
      .col-sm-10
        - if @merge_request.target_project.labels.any?
          = f.collection_select :label_ids, @merge_request.target_project.labels.all, :id, :name, {selected: @merge_request.label_ids}, multiple: true, class: 'select2'
        - else
          %span.light ラベルがありません
        &nbsp;
        - if can? current_user, :admin_label, @merge_request.target_project
          = link_to 'ラベルを作成', new_project_label_path(@merge_request.target_project), target: :blank

    .form-actions
      - if contribution_guide_url(@target_project)
        %p
          このリポジトリの
          %strong #{link_to 'コントリビューション・ガイドライン', contribution_guide_url(@target_project)}
          を確認してください
      = f.hidden_field :source_project_id
      = f.hidden_field :source_branch
      = f.hidden_field :target_project_id
      = f.hidden_field :target_branch
      = f.submit 'マージリクエストを送信', class: 'btn btn-create'

.mr-compare.merge-request
  %ul.nav.nav-tabs.merge-request-tabs
    %li.commits-tab{data: {action: 'commits'}}
      = link_to url_for(params) do
        %i.fa.fa-history
        コミット
        %span.badge= @commits.size
    %li.diffs-tab{data: {action: 'diffs'}}
      = link_to url_for(params) do
        %i.fa.fa-list-alt
        変更
        %span.badge= @diffs.size

  .commits.tab-content
    = render "projects/commits/commits", project: @project
  .diffs.tab-content
    - if @diffs.present?
      = render "projects/diffs/diffs", diffs: @diffs, project: @project
    - elsif @commits.size > MergeRequestDiff::COMMITS_SAFE_SIZE
      .bs-callout.bs-callout-danger
        %h4 この比較には #{MergeRequestDiff::COMMITS_SAFE_SIZE} コミット以上が含まれています
        %p パフォーマンスを維持するため、変更行は表示されません。
    - else
      .bs-callout.bs-callout-danger
        %h4 この比較の差分は大きすぎます
        %p パフォーマンスを維持するため、変更行は表示されません。

:javascript
  $('.assign-to-me-link').on('click', function(e){
    $('#merge_request_assignee_id').val("#{current_user.id}").trigger("change");
    e.preventDefault();
  });

  window.project_image_path_upload = "#{upload_image_project_path @project}";

:javascript
  var merge_request
  merge_request = new MergeRequest({
    action: 'commits'
  });
